<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Examen E2 ‚Äî RCCC</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <style>
        .exam-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        .exam-title {
            flex: 1;
            min-width: 300px;
        }
        .exam-title h1 {
            margin-bottom: 5px;
        }
        .exam-timer {
            background: var(--primary-light);
            padding: 15px 25px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            text-align: center;
            min-width: 150px;
        }
        .exam-timer .time {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary-dark);
            font-family: 'Courier New', monospace;
        }
        .exam-timer.warning .time {
            color: var(--warning);
        }
        .exam-timer.danger .time {
            color: var(--danger);
        }
        .exam-timer small {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9em;
            margin-top: 5px;
        }
        .question-container {
            margin-bottom: 40px;
            padding: 30px;
            background: white;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
        }
        .question-number {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-weight: 600;
        }
        .question-text {
            font-size: 1.1em;
            margin-bottom: 20px;
            color: var(--text-primary);
            line-height: 1.6;
        }
        .question-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 15px;
            background: var(--primary-light);
            color: var(--primary-dark);
        }
        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .option-label {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-label:hover {
            background: var(--gray-50);
            border-color: var(--primary);
        }
        .option-label input[type="radio"],
        .option-label input[type="checkbox"] {
            margin-top: 2px;
            cursor: pointer;
        }
        .option-label input:checked ~ .option-text {
            font-weight: 600;
            color: var(--primary-dark);
        }
        .option-text {
            flex: 1;
            color: var(--text-secondary);
        }
        .open-answer {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            font-size: 0.95em;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
        }
        .open-answer:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .loading-state {
            text-align: center;
            padding: 60px 20px;
        }
        .invalid-token {
            text-align: center;
            padding: 60px 20px;
        }
        .invalid-token h2 {
            color: var(--danger);
            margin-bottom: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-300);
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-dark), var(--primary));
            width: 0%;
            transition: width 0.3s ease;
        }
        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .form-actions button {
            min-width: 150px;
        }
        .question-info {
            background: var(--primary-light);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 30px;
            border-left: 4px solid var(--primary);
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span>üéì RCCC</span>
        </div>
        <div id="examType">Examen E2</div>
    </header>

    <div class="container">
        <!-- Estado de carga -->
        <div id="loadingState" class="loading-state" style="display: none;">
            <span class="loading"></span>
            <p>Cargando tu examen...</p>
        </div>

        <!-- Token inv√°lido -->
        <div id="invalidTokenState" style="display: none;">
            <div class="card invalid-token">
                <h2>‚ùå Link Inv√°lido o Expirado</h2>
                <p style="margin-bottom: 20px;">Lo sentimos, el link del examen no es v√°lido o ha expirado.</p>
                <div style="background: var(--warning-light); padding: 20px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>¬øQu√© puedes hacer?</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>Verifica que el link sea correcto</li>
                        <li>Revisa tu email para un link nuevo</li>
                        <li>Contacta con admin@rccc.org si el problema persiste</li>
                    </ul>
                </div>
                <button class="btn btn-secondary" onclick="window.location.href='/'">Volver al inicio</button>
            </div>
        </div>

        <!-- Contenido principal -->
        <div id="mainContent" style="display: none;">
            <div class="card">
                <div class="exam-header">
                    <div class="exam-title">
                        <h1 id="examTitle">Examen E2</h1>
                        <p id="examSubtitle">Parte de tu proceso de evaluaci√≥n en RCCC</p>
                    </div>
                    <div class="exam-timer" id="timerDisplay">
                        <div class="time" id="timeDisplay">120:00</div>
                        <small>Tiempo restante</small>
                    </div>
                </div>

                <div class="question-info">
                    <strong>‚ÑπÔ∏è Informaci√≥n importante:</strong>
                    <ul style="margin: 10px 0 0 20px;">
                        <li>Completa todas las preguntas</li>
                        <li>Dispondr√°s de <span id="examDurationText">120 minutos</span> para completar el examen</li>
                        <li>No podr√°s saltar preguntas</li>
                        <li>S√© honesto en tus respuestas</li>
                    </ul>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>

                <form id="examForm">
                    <div id="questionsContainer"></div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="confirmCancel()">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            ‚úì Enviar Examen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../assets/js/api.js"></script>
    <script>
        // Configuraci√≥n del examen
        let examData = {
            exam: 'E2',
            candidateId: null,
            token: null,
            startTime: null,
            duration: 120, // minutos
            questions: [],
            timerInterval: null
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', async () => {
            const params = getUrlParams();
            examData.candidateId = params.uid;
            examData.token = params.token;

            if (!examData.candidateId || !examData.token) {
                showInvalidToken();
                return;
            }

            try {
                showLoadingState();

                // Validar token
                const validation = await validateToken(examData.token);
                if (!validation || !validation.success) {
                    showInvalidToken();
                    return;
                }

                // Aqu√≠ ir√≠an las preguntas desde GAS
                // Por ahora, usaremos preguntas de ejemplo
                loadExampleQuestions();

                showMainContent();
                startTimer();
            } catch (error) {
                console.error('Error:', error);
                showInvalidToken();
            }
        });

        function loadExampleQuestions() {
            // NOTA: En producci√≥n, estas preguntas vendr√≠an de GAS
            // por ahora usamos ejemplos para demostrar la funcionalidad
            examData.questions = [
                {
                    id: 1,
                    type: 'multiple',
                    text: 'En el contexto de la terapia psicol√≥gica desde una perspectiva cat√≥lica, ¬øcu√°l es el rol principal de la esperanza?',
                    options: [
                        'Proporcionar un sentido de prop√≥sito y futuro positivo',
                        'Reemplazar completamente el tratamiento farmacol√≥gico',
                        'Eliminar toda experiencia de sufrimiento',
                        'Ser un recurso secundario en la terapia'
                    ],
                    correct: 0
                },
                {
                    id: 2,
                    type: 'multiple',
                    text: '¬øCu√°l es la importancia de la empat√≠a en la pr√°ctica cl√≠nica?',
                    options: [
                        'Permite comprender la experiencia del cliente',
                        'Facilita una relaci√≥n terap√©utica efectiva',
                        'Ambas anteriores',
                        'Ninguna de las anteriores'
                    ],
                    correct: 2
                },
                {
                    id: 3,
                    type: 'open',
                    text: '¬øC√≥mo integras los valores cat√≥licos en tu pr√°ctica profesional?',
                    maxLength: 1000
                }
            ];
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            examData.questions.forEach((question, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-container';

                let questionHTML = `
                    <div class="question-number">Pregunta ${index + 1} de ${examData.questions.length}</div>
                    <div class="question-type">${question.type === 'multiple' ? '‚úì Selecci√≥n m√∫ltiple' : 'üìù Respuesta abierta'}</div>
                    <div class="question-text">${question.text}</div>
                `;

                if (question.type === 'multiple') {
                    questionHTML += '<div class="options">';
                    question.options.forEach((option, optIndex) => {
                        questionHTML += `
                            <label class="option-label">
                                <input type="radio" name="question_${question.id}" value="${optIndex}" required>
                                <div class="option-text">${option}</div>
                            </label>
                        `;
                    });
                    questionHTML += '</div>';
                } else {
                    questionHTML += `
                        <textarea
                            class="open-answer"
                            name="question_${question.id}"
                            placeholder="Escribe tu respuesta aqu√≠..."
                            maxlength="${question.maxLength}"
                            required></textarea>
                        <small style="display: block; margin-top: 5px; color: var(--text-secondary);">
                            M√°ximo: ${question.maxLength} caracteres
                        </small>
                    `;
                }

                questionDiv.innerHTML = questionHTML;
                container.appendChild(questionDiv);
            });
        }

        function startTimer() {
            examData.startTime = Date.now();
            let secondsLeft = examData.duration * 60;

            function updateTimer() {
                const minutes = Math.floor(secondsLeft / 60);
                const seconds = secondsLeft % 60;
                const timeStr = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                document.getElementById('timeDisplay').textContent = timeStr;

                const timerDisplay = document.getElementById('timerDisplay');
                timerDisplay.classList.remove('warning', 'danger');

                if (secondsLeft <= 300) {
                    timerDisplay.classList.add('danger');
                    if (secondsLeft % 10 === 0 && secondsLeft > 0) {
                        showAlert('‚è∞ Quedan menos de 5 minutos', 'warning');
                    }
                } else if (secondsLeft <= 600) {
                    timerDisplay.classList.add('warning');
                }

                if (secondsLeft <= 0) {
                    clearInterval(examData.timerInterval);
                    submitExam();
                } else {
                    secondsLeft--;
                }
            }

            updateTimer();
            examData.timerInterval = setInterval(updateTimer, 1000);

            // Advertencia si intenta salir
            window.addEventListener('beforeunload', (e) => {
                if (secondsLeft > 0) {
                    e.preventDefault();
                    e.returnValue = '¬øEst√°s seguro de que quieres salir? Perder√°s tu progreso.';
                }
            });
        }

        function updateProgress() {
            const form = document.getElementById('examForm');
            const inputs = form.querySelectorAll('input[type="radio"], textarea');
            const answered = Array.from(inputs).filter(input => {
                if (input.type === 'radio') {
                    return input.checked;
                } else if (input.tagName === 'TEXTAREA') {
                    return input.value.trim().length > 0;
                }
                return false;
            }).length;

            const total = examData.questions.length;
            const percentage = (answered / total) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
        }

        document.getElementById('examForm').addEventListener('submit', submitExam);
        document.getElementById('examForm').addEventListener('change', updateProgress);

        async function submitExam(e) {
            if (e) e.preventDefault();

            if (!confirm('¬øEst√°s seguro de que quieres enviar el examen?')) {
                return;
            }

            clearInterval(examData.timerInterval);

            // Recolectar respuestas
            const answers = {};
            examData.questions.forEach(question => {
                const nameAttr = `question_${question.id}`;
                const input = document.querySelector(`[name="${nameAttr}"]`);

                if (input.type === 'radio') {
                    const checked = document.querySelector(`[name="${nameAttr}"]:checked`);
                    answers[question.id] = checked ? checked.value : null;
                } else {
                    answers[question.id] = input.value;
                }
            });

            try {
                const result = await submitExam(examData.exam, examData.candidateId, examData.token, answers);

                if (result && result.success) {
                    showAlert('‚úÖ ¬°Examen enviado exitosamente!', 'success');

                    setTimeout(() => {
                        window.location.href = '/gracias/';
                    }, 2000);
                } else {
                    showAlert('Error al enviar examen: ' + (result?.error || 'Error desconocido'), 'error');
                }
            } catch (error) {
                showAlert('Error: ' + error, 'error');
            }
        }

        function confirmCancel() {
            if (confirm('¬øCancelar el examen? Perder√°s todo tu progreso.')) {
                window.location.href = '/';
            }
        }

        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        function showInvalidToken() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('invalidTokenState').style.display = 'block';
        }

        function showMainContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            renderQuestions();
        }
    </script>
</body>
</html>
